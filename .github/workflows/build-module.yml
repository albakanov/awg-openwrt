name: Build AWG for GL-MT6000 (SDK)

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      TAG: "24.10.4"
      TARGET: "mediatek"
      SUBTARGET: "filogic"
      ARCH: "aarch64_cortex-a53"
      VERMAGIC: "9469a6c8c449c47e503c05678ea1559d"

    steps:
      # 0. Забираем твой репозиторий с пакетами
      - name: Checkout AWG repo
        uses: actions/checkout@v4

      # 1. Качаем и распаковываем SDK
      - name: Download OpenWrt SDK
        run: |
          wget https://archive.openwrt.org/releases/${TAG}/targets/${TARGET}/${SUBTARGET}/openwrt-sdk-${TAG}-${TARGET}-${SUBTARGET}_gcc-13.3.0_musl.Linux-x86_64.tar.zst
          tar -I zstd -xf openwrt-sdk-${TAG}-${TARGET}-${SUBTARGET}_gcc-13.3.0_musl.Linux-x86_64.tar.zst

          SDK_DIR=$(find . -maxdepth 1 -type d -name "openwrt-sdk-*")
          echo ">> Detected SDK dir: $SDK_DIR"
          mv "$SDK_DIR" sdk

      # 2. Кладём твои пакеты прямо в sdk/package/awg/
      - name: Copy AWG packages into SDK
        run: |
          PKG_AWG_DIR="sdk/package/awg"
          mkdir -p "$PKG_AWG_DIR"

          cp -r kmod-amneziawg "$PKG_AWG_DIR/"
          cp -r amneziawg-tools "$PKG_AWG_DIR/"
          cp -r luci-app-amneziawg "$PKG_AWG_DIR/"

          echo ">> AWG packages under:"
          ls -R "$PKG_AWG_DIR"

      # 3. Обновляем стандартные feeds OpenWrt
      - name: Update & install feeds
        working-directory: sdk
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

          echo "=== PACKAGE TREE ==="
          ls -R package || true

      # 4. Готовим .config и включаем наши пакеты
      - name: Prepare .config
        working-directory: sdk
        run: |
          wget https://archive.openwrt.org/releases/${TAG}/targets/${TARGET}/${SUBTARGET}/config.buildinfo -O .config

          cat << 'EOF' >> .config
          CONFIG_PACKAGE_kmod-amneziawg=m
          CONFIG_PACKAGE_amneziawg-tools=y
          CONFIG_PACKAGE_luci-app-amneziawg=y
          
          CONFIG_PACKAGE_kmod-crypto-lib-chacha20=m
          CONFIG_PACKAGE_kmod-crypto-lib-chacha20poly1305=m
          CONFIG_PACKAGE_kmod-crypto-lib-curve25519=m
          CONFIG_PACKAGE_kmod-crypto-poly1305=m
          CONFIG_PACKAGE_kmod-crypto-user=m
          EOF

          make defconfig

      # 5. Подкидываем исходники WireGuard в kernel tree
      - name: Inject WireGuard sources
        working-directory: sdk
        run: |
          wget https://www.kernel.org/pub/linux/kernel/v6.x/linux-6.6.110.tar.xz
          tar -xf linux-6.6.110.tar.xz linux-6.6.110/drivers/net/wireguard

          KDIR=$(echo build_dir/target-*/linux-*/linux-*)
          echo ">> KERNEL DIR = $KDIR"

          mkdir -p "$KDIR/drivers/net"
          rm -rf "$KDIR/drivers/net/wireguard"
          cp -r linux-6.6.110/drivers/net/wireguard "$KDIR/drivers/net/"

      # 6. Собираем kmod-amneziawg
      - name: Build kmod-amneziawg
        working-directory: sdk
        run: |
          make package/kmod-amneziawg/compile V=s

      # 7. Проверяем vermagic
      - name: Verify vermagic
        working-directory: sdk
        run: |
          VM=$(cat build_dir/target-*/linux-*/linux-*/.vermagic)
          echo "Built vermagic: $VM"
          [[ "$VM" == "${VERMAGIC}" ]] || (echo "!!! VERMAGIC DOES NOT MATCH !!!" && exit 1)

      # 8. Собираем userspace (tools + LuCI)
      - name: Build amneziawg-tools + LuCI
        working-directory: sdk
        run: |
          make package/amneziawg-tools/compile V=s
          make package/luci-app-amneziawg/compile V=s

      # 9. Сбор .ipk
      - name: Collect artifacts
        run: |
          mkdir -p awgrelease

          # наши userspace пакеты в package/awg
          cp sdk/bin/packages/${ARCH}/base/*amneziawg-tools*.ipk awgrelease/ 2>/dev/null || true
          cp sdk/bin/packages/${ARCH}/base/*luci-app-amneziawg*.ipk awgrelease/ 2>/dev/null || true
          cp sdk/bin/packages/${ARCH}/awg/*amneziawg*.ipk awgrelease/ 2>/dev/null || true

          # kmod идёт в targets/...
          cp sdk/bin/targets/${TARGET}/${SUBTARGET}/packages/kmod-amneziawg_*.ipk awgrelease/ 2>/dev/null || true

          echo "=== RELEASE FILES ==="
          ls -l awgrelease || echo "No artifacts collected"

      # 10. Release на GitHub
      - name: Publish release
        uses: softprops/action-gh-release@v1
        with:
          files: awgrelease/*.ipk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

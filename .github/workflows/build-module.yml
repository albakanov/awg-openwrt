name: Build AWG for GL-MT6000

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout AWG feed
        uses: actions/checkout@v4

      - name: Download OpenWrt SDK (24.10.4 filogic)
        run: |
          wget https://archive.openwrt.org/releases/24.10.4/targets/mediatek/filogic/openwrt-sdk-24.10.4-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64.tar.zst
          tar -I zstd -xf openwrt-sdk-24.10.4-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64.tar.zst
          mv openwrt-sdk-24.10.4-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64 sdk

      - name: Copy AWG packages into SDK
        run: |
          cp -r amneziawg-tools sdk/package/
          cp -r kmod-amneziawg sdk/package/
          cp -r luci-app-amneziawg sdk/package/

      - name: Build packages (inject WireGuard sources)
        working-directory: sdk
        run: |
          set -e

          echo "src-link local $(pwd)/package" >> feeds.conf.default

          ./scripts/feeds update -a
          ./scripts/feeds install -a

          echo ">>> Fetch OpenWrt config.buildinfo"
          wget https://archive.openwrt.org/releases/24.10.4/targets/mediatek/filogic/config.buildinfo -O .config

          echo ">>> Enable crypto + AWG (NO kmod-wireguard)"
          cat << 'EOF' >> .config
CONFIG_PACKAGE_kmod-amneziawg=m
CONFIG_PACKAGE_amneziawg-tools=y
CONFIG_PACKAGE_luci-app-amneziawg=y

CONFIG_PACKAGE_kmod-crypto-lib-chacha20=y
CONFIG_PACKAGE_kmod-crypto-lib-chacha20poly1305=y
CONFIG_PACKAGE_kmod-crypto-lib-curve25519=y
CONFIG_PACKAGE_kmod-crypto-chacha20poly1305=y
CONFIG_PACKAGE_kmod-crypto-poly1305=y
CONFIG_PACKAGE_kmod-crypto-acompress=y
CONFIG_PACKAGE_kmod-crypto-kpp=y
CONFIG_PACKAGE_kmod-crypto-user=y
CONFIG_PACKAGE_kmod-crypto-misc=y

CONFIG_CRYPTO_CHACHA20=y
CONFIG_CRYPTO_CHACHA20_NEON=y
CONFIG_CRYPTO_POLY1305=y
CONFIG_CRYPTO_POLY1305_NEON=y
CONFIG_CRYPTO_CURVE25519=y
CONFIG_CRYPTO_CURVE25519_NEON=y
CONFIG_CRYPTO_LIB_CURVE25519_GENERIC=y
CONFIG_CRYPTO_LIB_CHACHA20_GENERIC=y
CONFIG_CRYPTO_LIB_POLY1305_GENERIC=y
CONFIG_CRYPTO_LIB_POLY1305=y
CONFIG_CRYPTO_LIB_CHACHA20=y
EOF

          echo ">>> Run defconfig"
          make defconfig

          echo ">>> Download Linux 6.6.110 for WireGuard sources"
          wget https://www.kernel.org/pub/linux/kernel/v6.x/linux-6.6.110.tar.xz
          tar -xf linux-6.6.110.tar.xz linux-6.6.110/drivers/net/wireguard

          echo ">>> Locate kernel dir in SDK"
          KDIR=$(echo build_dir/target-*_cortex-a53_musl/linux-*/linux-*)
          echo "Kernel dir: $KDIR"

          echo ">>> Inject WireGuard sources into kernel tree"
          mkdir -p "$KDIR/drivers/net"
          rm -rf "$KDIR/drivers/net/wireguard"
          cp -r linux-6.6.110/drivers/net/wireguard "$KDIR/drivers/net/"

          ls -R "$KDIR/drivers/net/wireguard" || true

          echo ">>> Build kmod-amneziawg"
          make package/kmod-amneziawg/{clean,prepare,compile} V=s

          echo ">>> Build amneziawg-tools"
          make package/amneziawg-tools/{clean,prepare,compile} V=s

          echo ">>> Build luci-app-amneziawg"
          make package/luci-app-amneziawg/{clean,prepare,compile} V=s

      - name: Prepare artifacts
        run: |
          mkdir -p awgrelease
          cp sdk/bin/packages/aarch64_cortex-a53/*/amneziawg-tools_*.ipk awgrelease/ || true
          cp sdk/bin/packages/aarch64_cortex-a53/*/luci-app-amneziawg_*.ipk awgrelease/ || true
          cp sdk/bin/targets/mediatek/filogic/packages/kmod-amneziawg_*.ipk awgrelease/ || true

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          files: awgrelease/*.ipk
